{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h3><strong>Manage Case Types</strong></h3>

    <!-- Case Type List -->
    <div class="mt-3 mb-4">
        <ul id="caseTypeList" class="list-group">
            <!-- Case types will be dynamically inserted here -->
        </ul>
    </div>

    <!-- Add New Case Type -->
    <div class="input-group mt-3">
        <input type="text" id="newCaseType" class="form-control" placeholder="Enter new case type">
        <button class="btn btn-success" onclick="addCaseType()">ADD NEW</button>
    </div>
    <div id="caseTypeError" class="text-danger mt-2" style="display: none;"></div>

    <!-- Back Button -->
    <a href="/supporthub/?user={{ current_user.username }}" class="btn btn-secondary mt-3">Back</a>
</div>

<script>
// Helper function to get authenticated URL
function getAuthenticatedUrl(endpoint) {
    const urlParams = new URLSearchParams(window.location.search);
    const user = urlParams.get('user');
    return `${endpoint}${endpoint.includes('?') ? '&' : '?'}user=${user}`;
}

// Fetch and display case types from backend
function fetchCaseTypes() {
    fetch(getAuthenticatedUrl('/supporthub/api/case-types'))
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(caseTypes => {
            const caseTypeList = document.getElementById("caseTypeList");
            caseTypeList.innerHTML = ""; // Clear old data

            if (Array.isArray(caseTypes)) {
                caseTypes.forEach(caseType => {
                    const listItem = document.createElement("li");
                    listItem.className = "list-group-item d-flex justify-content-between align-items-center";
                    listItem.dataset.id = caseType.id;
                    
                    // Escape special characters in the name
                    const escapedName = caseType.name.replace(/'/g, "\\'");
                    
                    listItem.innerHTML = `
                        <span class="case-type-name">${caseType.name}</span>
                        <div>
                            <button class="btn btn-sm btn-warning me-1" onclick="editCaseType(${caseType.id}, '${escapedName}')">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCaseType(${caseType.id}, '${escapedName}')">Delete</button>
                        </div>
                    `;
                    caseTypeList.appendChild(listItem);
                });
            } else {
                showError("No case types found or invalid data received");
            }
        })
        .catch(error => {
            console.error("Error fetching case types:", error);
            showError("Failed to load case types");
        });
}

// Add a new case type
function addCaseType() {
    const input = document.getElementById("newCaseType");
    const newCaseType = input.value.trim();
    
    if (!newCaseType) {
        showError("Please enter a case type name");
        return;
    }

    fetch(getAuthenticatedUrl('/supporthub/api/case-types/add'), {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: newCaseType })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showError(data.error);
        } else {
            hideError();
            input.value = ''; // Clear input field
            fetchCaseTypes(); // Refresh the list
        }
    })
    .catch(error => {
        console.error('Error adding case type:', error);
        showError("Failed to add case type");
    });
}

// Edit a case type
function editCaseType(caseTypeId, currentName) {
    const newName = prompt("Edit case type name:", currentName);
    if (!newName || newName.trim() === currentName) return;

    fetch(getAuthenticatedUrl(`/supporthub/api/case-types/${caseTypeId}`), {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name: newName.trim() })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showError(data.error);
        } else {
            hideError();
            fetchCaseTypes();
        }
    })
    .catch(error => {
        console.error("Error editing case type:", error);
        showError("Failed to update case type");
    });
}

// Delete a case type
function deleteCaseType(caseTypeId, name) {
    if (!confirm(`Are you sure you want to delete "${name}"?`)) return;

    fetch(getAuthenticatedUrl(`/supporthub/api/case-types/${caseTypeId}`), {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showError(data.error);
        } else {
            hideError();
            fetchCaseTypes();
        }
    })
    .catch(error => {
        console.error("Error deleting case type:", error);
        showError("Failed to delete case type");
    });
}

// Error handling functions
function showError(message) {
    const errorDiv = document.getElementById("caseTypeError");
    errorDiv.textContent = message;
    errorDiv.style.display = "block";
}

function hideError() {
    const errorDiv = document.getElementById("caseTypeError");
    errorDiv.style.display = "none";
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    fetchCaseTypes();

    // Add enter key support for the input field
    document.getElementById('newCaseType').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            addCaseType();
        }
    });
});
</script>
{% endblock %}