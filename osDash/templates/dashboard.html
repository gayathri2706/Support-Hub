    {% extends "base.html" %}

    {% block title %}
    Dashboard
    {% endblock %}

    {% block content %}
    <div class="header-container d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Dashboard</h3>
    <div class="d-flex align-items-center">
        <div class="me-3">
            <select id="statusFilter" class="form-select" style="width: 150px;">
                <option value="" selected>All</option>
                <option value="Open">Open</option>
                <option value="Closed">Closed</option>
            </select>
        </div>
        <a href="/supporthub/new_ticket?foundry={{ foundry }}&username={{ username }}" class="btn btn-danger me-2">Open Ticket</a>
        <a class="btn btn-secondary" href="/supporthub/?user={{ current_user.username }}">Back</a>
    </div>
</div>


    <div class="table-container">
        <table class="table table-striped border">
            <thead>
                <tr>
                    <th><strong>ID</strong></th>
                    <th><strong>Date Created</strong></th>
                    <th><strong>Foundry</strong></th>
                    <th><strong>Case Type</strong></th>
                    <th><strong>Description</strong></th>
                    <th><strong>Priority</strong></th>
                    <th><strong>Status</strong></th>
                    <th><strong>Resolved Date</strong></th>
                    <th><strong>View Files</strong></th>
                    <th><strong>Assigned To</strong></th>
                </tr>
            </thead>
           <tbody id="ticketsTable">
    {% for ticket in tickets %}
    <tr id="row-{{ ticket.ticket_id }}" data-status="{{ ticket.status }}">
        <td>{{ ticket.ticket_id }}</td>
        <td>{{ ticket.date_created }}</td>
        <td>{{ ticket.foundry_name }}</td>
        <td>{{ ticket.issue }}</td>
        <td class="description-cell">
            <div class="description-content" data-full-text="{{ ticket.issue_description or '' }}">
                <span class="description-text">
                    {% if ticket.issue_description and ticket.issue_description|length > 60 %}
                        {{ ticket.issue_description[:60] }}...
                        <a href="#" class="see-more-btn text-primary" onclick="toggleDescription(this, event)">See more</a>
                    {% else %}
                        {{ ticket.issue_description or 'No description available' }}
                    {% endif %}
                </span>
            </div>
        </td>
        <td class="priority-column">
            <span id="priority-{{ ticket.ticket_id }}" class="priority-badge" data-priority="{{ ticket.priority }}">
                {{ ticket.priority }}
            </span>
        </td>
                    <td class="status-column">
                        <div class="status-wrapper">
                            <select class="form-select status-dropdown" id="status-{{ ticket.ticket_id }}"
                                onchange="handleStatusChange('{{ ticket.ticket_id }}')"
                                data-status="{{ ticket.status }}"
                                {% if ticket.status == 'Closed' %}disabled{% endif %}>
                                <option value="Open" {% if ticket.status == 'Open' %}selected{% endif %}>Open</option>
                                <option value="Closed" {% if ticket.status == 'Closed' %}selected{% endif %}>Closed</option>
                            </select>
                        </div>
                    </td>
                    <td>{{ ticket.resolved_time or 'N/A' }}</td>
                    <td>
                        {% if ticket.attachment_file %}
                            <a href="/supporthub/uploads/user_files/{{ ticket.attachment_file }}" target="_blank" class="btn btn-sm btn-info">View File</a>
                        {% else %}
                            <span>No File</span>
                        {% endif %}
                    </td>
                    <td>
                        <button id="assign-button-{{ ticket.ticket_id }}" class="btn btn-sm btn-outline-primary"
                            {% if ticket.status == 'Closed' %}disabled{% endif %}
                            onclick="openAssignModal('{{ ticket.ticket_id }}', '{{ ticket.assigned_to }}', '{{ ticket.assigned_email }}')">
                            {{ ticket.assigned_to or 'Unassigned' }}
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination-container d-flex justify-content-center align-items-center mt-2 mb-0">
        <button id="firstPage" class="btn btn-sm btn-dark me-2">⏮</button>
        <button id="prevPage" class="btn btn-sm btn-dark me-2">◀</button>
        <span id="paginationInfo" class="mx-3"></span>
        <button id="nextPage" class="btn btn-sm btn-dark me-2">▶</button>
        <button id="lastPage" class="btn btn-sm btn-dark me-2">⏭</button>
    </div>

    <!-- Assign Modal -->
    <div class="modal fade" id="assignModal" tabindex="-1" aria-labelledby="assignModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assignModalLabel">Assign Ticket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="assignForm">
                        <div class="mb-3">
                            <label for="assign-name" class="form-label">Assign To:</label>
                            <select id="assign-name" name="assign_name" class="form-select" required></select>
                        </div>
                        <div id="email-display" class="mt-2 text-muted" style="display: none;">
                            <strong>Email:</strong> <span id="assigned-email"></span>
                        </div>
                        <div class="mb-3">
                            <label for="assign-comment" class="form-label">Comment:</label>
                            <textarea id="assign-comment" name="assign_comment" class="form-control" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="assignTicket()">Assign</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Close Modal -->
    <div class="modal fade" id="closeTicketModal" tabindex="-1" aria-labelledby="closeTicketModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="closeTicketModalLabel">Close Ticket</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" onclick="revertStatusToOpen()"></button>
                </div>
                <div class="modal-body">
                    <input type="file" id="attach-file-modal" class="form-control">
                    <div class="mt-3">
                        <label for="close-comment" class="form-label">Add Comment:</label>
                        <textarea class="form-control" id="close-comment" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="revertStatusToOpen()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="closeTicketWithFile()">Close Ticket</button>
                </div>
            </div>
        </div>
    </div>

    <div class="chart-container">
        <div class="col-md-6">
            <div id="caseTypeChart" style="height: 330px;"></div>
        </div>
        <div class="col-md-6">
            <div id="priorityChart" style="height: 330px;"></div>
        </div>
    </div>

    <script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/treemap.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>

    <script>
    let currentAssignTicketId = null;
    let previousStatus = null;

    function openAssignModal(ticketId, assignedName, assignedEmail) {
        currentAssignTicketId = ticketId;
        document.getElementById('assignModalLabel').textContent = assignedName ? 'Edit Assigned Ticket' : 'Assign Ticket';

        fetch('/supporthub/api/assignable-users')
            .then(response => response.json())
            .then(data => {
                const assignSelect = document.getElementById('assign-name');
                assignSelect.innerHTML = '';
                data.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.name} (${user.email})`;
                    if (user.name === assignedName) option.selected = true;
                    assignSelect.appendChild(option);
                });

                const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('assignModal'));
                modal.show();
            })
            .catch(error => console.error('Error fetching assignable users:', error));
    }

    function assignTicket() {
        const assignId = document.getElementById('assign-name').value;
        const assignComment = document.getElementById('assign-comment').value;
        if (!assignId || !assignComment) {
            alert('Please fill in all fields.');
            return;
        }

        fetch(`/supporthub/api/tickets/${currentAssignTicketId}/assign`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ assignee_id: assignId, comment: assignComment }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Ticket assigned successfully!');
                location.reload();
            } else {
                alert('Failed to assign ticket: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error assigning ticket:', error);
            alert('An error occurred. Please try again.');
        });
    }

    function handleStatusChange(ticketId) {
        const dropdown = document.getElementById(`status-${ticketId}`);
        const newStatus = dropdown.value;
        if (newStatus === 'Closed') {
            previousStatus = 'Open';
            window.currentTicketId = ticketId;
            const modal = new bootstrap.Modal(document.getElementById('closeTicketModal'));
            modal.show();
        } else {
            updateTicketStatus(ticketId, newStatus);
        }
    }

    function revertStatusToOpen() {
        if (previousStatus === 'Open') {
            const ticketId = window.currentTicketId;
            const dropdown = document.getElementById(`status-${ticketId}`);
            dropdown.value = 'Open';
        }
    }

    function closeTicketWithFile() {
        const ticketId = window.currentTicketId;
        const comment = document.getElementById('close-comment').value.trim();
        const fileInput = document.getElementById('attach-file-modal');
        const file = fileInput.files[0];

        if (!comment) {
            alert("Please add a comment before closing the ticket.");
            return;
        }

        const formData = new FormData();
        formData.append('comment', comment);
        if (file) formData.append('file', file);

        fetch(`/supporthub/api/tickets/${ticketId}/close`, {
            method: 'POST',
            body: formData,
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Ticket closed successfully!");
                document.getElementById(`status-${ticketId}`).value = "Closed";
                document.getElementById(`status-${ticketId}`).disabled = true;
                document.getElementById(`assign-button-${ticketId}`).disabled = true;

                const modal = bootstrap.Modal.getInstance(document.getElementById('closeTicketModal'));
                modal.hide();
            } else {
                alert("Error closing ticket: " + data.message);
            }
        })
        .catch(error => {
            console.error("Error:", error);
            alert("An unexpected error occurred while closing the ticket.");
        });
    }

    function updateTicketStatus(ticketId, status) {
        fetch(`/supporthub/api/tickets/${ticketId}`, {
            
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Ticket status updated successfully!');
                location.reload();
            } else {
                alert('Failed to update status: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error updating ticket status:', error);
            alert('An error occurred. Please try again.');
        });
    }

   document.addEventListener('DOMContentLoaded', function () {
    fetchChartData();
    applyFilters();

    document.getElementById("statusFilter").addEventListener("change", applyFilters);

    // Pagination
    document.getElementById('firstPage').addEventListener('click', () => { currentPage = 1; updatePagination(); });
    document.getElementById('prevPage').addEventListener('click', () => { if (currentPage > 1) currentPage--; updatePagination(); });
    document.getElementById('nextPage').addEventListener('click', () => {
        const totalPages = Math.ceil(totalRows / rowsPerPage);
        if (currentPage < totalPages) currentPage++;
        updatePagination();
    });
    document.getElementById('lastPage').addEventListener('click', () => {
        currentPage = Math.ceil(totalRows / rowsPerPage);
        updatePagination();
    });

    // Open Ticket Button
    const openTicketBtn = document.getElementById('openTicketButton');
    if (openTicketBtn) {
        openTicketBtn.addEventListener('click', () => {
            const foundry = "{{ foundry }}";
            const username = "{{ username or current_user.username }}";

            if (!username) {
                alert("Username missing");
                return;
            }

            const url = foundry === "All"
                ? `/supporthub/new_ticket?username=${encodeURIComponent(username)}`
                : `/supporthub/new_ticket?foundry=${encodeURIComponent(foundry)}&username=${encodeURIComponent(username)}`;

            window.location.href = url;
        });
    }
});

async function fetchChartData() {
    try {
        const rawFoundry = "{{ foundry }}";
        const foundryName = rawFoundry.toLowerCase() === "admin" ? "all" : rawFoundry;
        const response = await fetch(`/supporthub/api/chart-data?foundry_name=${encodeURIComponent(foundryName)}`);
        const data = await response.json();

        renderCaseTypeChart(data.case_types);
        renderPriorityChart(data.priority);
    } catch (error) {
        console.error('Error fetching chart data:', error);
    }
}


function renderCaseTypeChart(data) {
    // Convert data to treemap format
    const treeMapData = data.map(item => {
        if (Array.isArray(item)) {
            return {
                name: item[0],
                value: item[1],
                colorValue: item[1]
            };
        } else if (typeof item === 'object' && item.name) {
            return {
                name: item.name,
                value: item.y || item.value,
                colorValue: item.y || item.value
            };
        } else {
            return {
                name: 'Unknown',
                value: 0,
                colorValue: 0
            };
        }
    });

    // Sort data by value for better visualization
    treeMapData.sort((a, b) => b.value - a.value);

    // Calculate min, max, and range for dynamic color scaling
    const values = treeMapData.map(item => item.value).filter(v => v > 0);
    const minValue = Math.min(...values);
    const maxValue = Math.max(...values);
    const range = maxValue - minValue;

    // Enhanced function to generate color based on value with better contrast
    function getColorByValue(value) {
        if (range === 0) return '#4CAF50'; // Default green if all values are same
        
        // Normalize value to 0-1 scale
        const normalized = (value - minValue) / range;
        
        // Enhanced green color palette with better contrast
        // Light green for low values, very dark green for high values
        const lightGreen = { r: 165, g: 214, b: 167 };  // #A5D6A7 - Light green
        const mediumGreen = { r: 76, g: 175, b: 80 };   // #4CAF50 - Medium green  
        const darkGreen = { r: 27, g: 94, b: 32 };      // #1B5E20 - Dark green
        
        let targetColor;
        let adjustedNormalized;
        
        if (normalized <= 0.5) {
            // Interpolate between light and medium green (0-0.5)
            adjustedNormalized = normalized * 2; // Scale to 0-1
            targetColor = {
                r: Math.round(lightGreen.r + (mediumGreen.r - lightGreen.r) * adjustedNormalized),
                g: Math.round(lightGreen.g + (mediumGreen.g - lightGreen.g) * adjustedNormalized),
                b: Math.round(lightGreen.b + (mediumGreen.b - lightGreen.b) * adjustedNormalized)
            };
        } else {
            // Interpolate between medium and dark green (0.5-1)
            adjustedNormalized = (normalized - 0.5) * 2; // Scale to 0-1
            targetColor = {
                r: Math.round(mediumGreen.r + (darkGreen.r - mediumGreen.r) * adjustedNormalized),
                g: Math.round(mediumGreen.g + (darkGreen.g - mediumGreen.g) * adjustedNormalized),
                b: Math.round(mediumGreen.b + (darkGreen.b - mediumGreen.b) * adjustedNormalized)
            };
        }
        
        return `rgb(${targetColor.r}, ${targetColor.g}, ${targetColor.b})`;
    }

    Highcharts.chart('caseTypeChart', {
        chart: { 
            type: 'treemap',
            height: 330,
            backgroundColor: '#FAFAFA'
        },
        title: { 
            text: 'Case Type Distribution',
            style: {
                fontSize: '16px',
                fontWeight: 'bold',
            }
        },
        credits: { enabled: false },
        tooltip: {
            pointFormat: '<b>{point.name}</b><br>Count: {point.value}<br>Percentage: {point.percentage:.1f}%',
            backgroundColor: '#FFFFFF',
            borderColor: '#2E7D32',
            borderRadius: 8,
            shadow: true
        },
        plotOptions: {
            treemap: {
                layoutAlgorithm: 'squarified',
                borderWidth: 3,
                borderColor: '#FFFFFF',
                borderRadius: 4,
                dataLabels: {
                    enabled: true,
                    useHTML: false,
                    formatter: function() {
                        const totalValue = this.series.data.reduce((sum, point) => sum + point.value, 0);
                        const percentage = (this.point.value / totalValue * 100);
                        
                        // For very small sections (less than 8% of total), put text beside number
                        if (percentage < 8) {
                            return `${this.point.name} ${this.point.value}`;
                        } else {
                            return `${this.point.name}<br><b>${this.point.value}</b>`;
                        }
                    },
                    style: {
                        fontSize: '10px',
                        fontWeight: 'bold',
                        color: 'contrast',
                    },
                    verticalAlign: 'middle',
                    align: 'center'
                },
                states: {
                    hover: {
                        brightness: 0.2,
                        borderColor: '#2E7D32',
                        borderWidth: 4
                    }
                }
            }
        },
        series: [{
            name: 'Cases',
            data: treeMapData.map((item) => {
                const totalValue = treeMapData.reduce((sum, d) => sum + d.value, 0);
                return {
                    ...item,
                    percentage: totalValue > 0 ? (item.value / totalValue * 100) : 0,
                    color: getColorByValue(item.value)
                };
            })
        }]
    });
}

function renderPriorityChart(data) {
    // Convert data to treemap format
    const treeMapData = data.map(item => {
        if (Array.isArray(item)) {
            return {
                name: item[0],
                value: item[1],
                colorValue: item[1]
            };
        } else if (typeof item === 'object' && item.name) {
            return {
                name: item.name,
                value: item.y || item.value,
                colorValue: item.y || item.value
            };
        } else {
            return {
                name: 'Unknown',
                value: 0,
                colorValue: 0
            };
        }
    });

    // Calculate min, max, and range for dynamic color scaling
    const values = treeMapData.map(item => item.value).filter(v => v > 0);
    const minValue = Math.min(...values);
    const maxValue = Math.max(...values);
    const range = maxValue - minValue;

    // Function to generate color based on value (red palette)
    function getColorByValue(value) {
        if (range === 0) return '#ff7b7b'; // Default red if all values are same
        
        // Normalize value to 0-1 scale
        const normalized = (value - minValue) / range;
        
        // Red color palette from light to dark
        const lightRed = { r: 255, g: 205, b: 205 }; // #FFCDCD
        const darkRed = { r: 183, g: 28, b: 28 };     // #B71C1C
        
        // Interpolate between light and dark red
        const r = Math.round(lightRed.r + (darkRed.r - lightRed.r) * normalized);
        const g = Math.round(lightRed.g + (darkRed.g - lightRed.g) * normalized);
        const b = Math.round(lightRed.b + (darkRed.b - lightRed.b) * normalized);
        
        return `rgb(${r}, ${g}, ${b})`;
    }

    Highcharts.chart('priorityChart', {
        chart: { 
            type: 'treemap',
            height: 330,
            backgroundColor: 'transparent',
            spacing: [5, 5, 5, 5]
        },
        title: { 
            text: 'Priority Distribution',
            align: 'center',
            style: {
                fontSize: '16px',
                fontWeight: '600',
                color: 'black',
                fontFamily: 'system-ui, -apple-system, sans-serif'
            }
        },
        credits: { enabled: false },
        tooltip: {
            useHTML: true,
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            borderColor: '#E0E0E0',
            borderRadius: 8,
            borderWidth: 1,
            shadow: {
                color: 'rgba(0, 0, 0, 0.1)',
                width: 4,
                offsetX: 2,
                offsetY: 2
            },
            style: {
                fontSize: '13px',
                fontFamily: 'system-ui, -apple-system, sans-serif'
            },
            formatter: function() {
                return `<div style="padding: 8px;">
                    <strong style="color: #8B4A47; font-size: 14px;">${this.point.name} Priority</strong><br>
                    <span style="color: #666;">Count: <strong>${this.point.value}</strong></span><br>
                    <span style="color: #666;">Percentage: <strong>${this.point.percentage.toFixed(1)}%</strong></span>
                </div>`;
            }
        },
        plotOptions: {
            treemap: {
                layoutAlgorithm: 'squarified',
                borderWidth: 2,
                borderColor: '#FFFFFF',
                borderRadius: 6,
                dataLabels: {
                    enabled: true,
                    useHTML: true,
                    formatter: function() {
                        return `<div style="text-align: center; line-height: 1.1;">
                            <div style="font-weight: 600; font-size: 11px; color: #5D3833; text-shadow: 1px 1px 2px rgba(255,255,255,0.3);">
                                ${this.point.name}
                            </div>
                            <div style="font-weight: 700; font-size: 14px; color: #5D3833; text-shadow: 1px 1px 2px rgba(255,255,255,0.3);">
                                ${this.point.value}
                            </div>
                        </div>`;
                    }
                },
                states: {
                    hover: {
                        brightness: 0.15,
                        borderColor: '#333333',
                        borderWidth: 3
                    }
                },
                animation: {
                    duration: 800
                }
            }
        },
        series: [{
            name: 'Tickets',
            data: treeMapData.map((item) => {
                const totalValue = treeMapData.reduce((sum, d) => sum + d.value, 0);
                return {
                    ...item,
                    percentage: totalValue > 0 ? (item.value / totalValue * 100) : 0,
                    color: getColorByValue(item.value)
                };
            })
        }]
    });
}

function renderPriorityChart(data) {
    // Convert data to treemap format
    const treeMapData = data.map(item => {
        if (Array.isArray(item)) {
            return {
                name: item[0],
                value: item[1],
                colorValue: item[1]
            };
        } else if (typeof item === 'object' && item.name) {
            return {
                name: item.name,
                value: item.y || item.value,
                colorValue: item.y || item.value
            };
        } else {
            return {
                name: 'Unknown',
                value: 0,
                colorValue: 0
            };
        }
    });

    // Define color palette: High (dark), Medium (medium), Low (light)
    const priorityColors = {
        'High': '#ff5252',   // Dark red
        'Medium': '#ff7b7b', // Medium red
        'Low': '#ffbaba'     // Light red
    };

    // Create chart
    Highcharts.chart('priorityChart', {
        chart: {
            type: 'treemap',
            height: 330,
            backgroundColor: 'transparent',
            spacing: [5, 5, 5, 5]
        },
        title: {
            text: 'Priority Distribution',
            align: 'center',
            style: {
                fontSize: '16px',
                fontWeight: 'bold',
                color: 'black',
                fontFamily: 'system-ui, -apple-system, sans-serif'
            }
        },
        credits: { enabled: false },
        tooltip: {
            useHTML: true,
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            borderColor: '#E0E0E0',
            borderRadius: 8,
            borderWidth: 1,
            shadow: {
                color: 'rgba(0, 0, 0, 0.1)',
                width: 4,
                offsetX: 2,
                offsetY: 2
            },
            style: {
                fontSize: '13px',
                fontFamily: 'system-ui, -apple-system, sans-serif'
            },
            formatter: function() {
                return `<div style="padding: 8px;">
                    <strong style="color: #8B4A47; font-size: 14px;">${this.point.name} Priority</strong><br>
                    <span style="color: #666;">Count: <strong>${this.point.value}</strong></span><br>
                    <span style="color: #666;">Percentage: <strong>${this.point.percentage.toFixed(1)}%</strong></span>
                </div>`;
            }
        },
        plotOptions: {
            treemap: {
                layoutAlgorithm: 'squarified',
                borderWidth: 2,
                borderColor: '#FFFFFF',
                borderRadius: 6,
                dataLabels: {
                    enabled: true,
                    useHTML: true,
                    formatter: function() {
                        return `<div style="text-align: center; line-height: 1.1;">
                            <div style="font-weight: 600; font-size: 11px; color: #5D3833; text-shadow: 1px 1px 2px rgba(255,255,255,0.3);">
                                ${this.point.name}
                            </div>
                            <div style="font-weight: 700; font-size: 14px; color: #5D3833; text-shadow: 1px 1px 2px rgba(255,255,255,0.3);">
                                ${this.point.value}
                            </div>
                        </div>`;
                    }
                },
                states: {
                    hover: {
                        brightness: 0.15,
                        borderColor: '#333333',
                        borderWidth: 3
                    }
                },
                animation: {
                    duration: 800
                }
            }
        },
        series: [{
            name: 'Tickets',
            data: treeMapData.map((item) => {
                const totalValue = treeMapData.reduce((sum, d) => sum + d.value, 0);
                return {
                    ...item,
                    percentage: totalValue > 0 ? (item.value / totalValue * 100) : 0,
                    color: priorityColors[item.name] || '#D4A5A0' // fallback for unknown
                };
            })
        }]
    });
}


// Pagination functions remain the same
const rowsPerPage = 4;
let currentPage = 1;
let totalRows = 0;

function applyFilters() {
    const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
    const rows = document.querySelectorAll('#ticketsTable tr');
    totalRows = 0;
    rows.forEach(row => {
        const status = row.getAttribute("data-status").toLowerCase();
        const visible = !statusFilter || status === statusFilter;
        row.setAttribute("data-visible", visible);
        if (visible) totalRows++;
    });
    currentPage = 1;
    updatePagination();
}

function updatePagination() {
    const rows = document.querySelectorAll('#ticketsTable tr');
    const totalPages = Math.ceil(totalRows / rowsPerPage);
    let visibleIndex = 0;
    rows.forEach(row => {
        if (row.getAttribute("data-visible") === "true") {
            row.style.display = (visibleIndex >= (currentPage - 1) * rowsPerPage && visibleIndex < currentPage * rowsPerPage) ? "" : "none";
            visibleIndex++;
        } else {
            row.style.display = "none";
        }
    });
    document.getElementById('paginationInfo').textContent = `Page ${currentPage} of ${totalPages || 1}`;
}

function toggleDescription(element, event) {
    event.preventDefault();
    
    const descriptionContent = element.closest('.description-content');
    const fullText = descriptionContent.getAttribute('data-full-text');
    const descriptionText = descriptionContent.querySelector('.description-text');
    
    if (element.textContent === 'See more') {
        descriptionText.innerHTML = fullText + ' <a href="#" class="see-more-btn text-primary" onclick="toggleDescription(this, event)">See less</a>';
    } else {
        const truncatedText = fullText.length > 60 ? fullText.substring(0, 60) + '...' : fullText;
        descriptionText.innerHTML = truncatedText + (fullText.length > 60 ? ' <a href="#" class="see-more-btn text-primary" onclick="toggleDescription(this, event)">See more</a>' : '');
    }
}
    </script>
    {% endblock %}
